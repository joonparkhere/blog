---
title: AMM, Uniswap V3
date: 2021-05-16
pin: false
tags:
- Blockchain
- Ethereum
- DeFi
---

# Uniswap V3 와 AMM



## Order Book 기반 중앙화 거래소

보통의 일반적인 거래소 (Upbit, Coinone 등) 는 각각의 거래소마다 Order Book 을 가지고 있다. 이 구조에서는 거래가 이뤄지기 위해, 판매 (매도) 하겠다고 하는 사람과 구매 (매수) 하겠다고 하는 사람의 짝이 맞아야 한다. 한 유저가 1 ETH를 매도하기 위해 매도 요청을 해놓고, 다른 유저가 1 ETH를 매수하겠다고 요청을 보내면 두 유저가 거래의 짝이 되어 체결된다. 이 일련의 과정과 거래 기록들을 해당 거래소의 서버에서 관리하므로, CEX (Centralized Exchange, 중앙화 거래소) 라고도 부른다.



## On-Chain Smart Contract 기반 탈중앙화 거래소

DEX (Decentralized Exchange) 는 CEX의 중앙적인 성격을 없앤 거래소이다. 즉, 거래소가 관리하는 Order Book은 존재하지 않고 따라서 당연히 거래의 체결을 위해 짝이 이뤄지지 않아도 된다. 그 대신에 DEX에는 유동성 풀 (Liquidity Pool) 이라는, Order Book을 대체하는 개념이 존재한다. 일부 유저들은 DEX에서 제공하는 경제적 이득 (거래 수수료 취득, 이자 농사 등) 을 얻기 위해 유동성 풀에 자신의 자산을 예치하며 유동성을 제공한다. 일반적인 거래는 `X` 자산을 `Y` 자산으로 Swap 하는 형태이므로, 유동성 풀에 유동성을 제공할 때도 두 자산의 Pair로써 예치해야 한다. 예를 들어, `ETH / DAI` 유동성 풀에 유동성을 제공하려면 동일한 가치의 `ETH`와 `DAI`를 동시에 예치해야 한다. 이렇게 DEX의 유동성 풀이 구축되면, 거래를 하려 하는 사용자는 그저 유동성 풀을 이용해 Swap을 하면 된다. 그래서 거래가 체결되기 위해 판매하고자 하는 유저와 구매하고자 하는 유저의 짝이 만들어질 필요가 없는 것이고, 그 대신에 거래를 요청하는 유저와 해당 거래를 처리할 수 있는 유동성 풀이 있으면 된다.



## AMM (Automated Market Maker)

DEX에서 핵심적인 유동성 풀 개념과 실질적인 Swap 과정은 AMM 기술로 구현된다. 쉽게 말하면, 특정 알고리즘을 사용해 거래를 수행한다. 각 DEX마다 사용하는 알고리즘 (수학 공식) 은 다르다. 주로 이용하는 방식으로는 다음과 같다.



### AMM 종류

- CFMM (Constant Function Market Maker)

  가장 널리 사용되는 방식이다. 상수 함수를 기반으로 거래 운영이 된다.

  - CPMM (Constant Product Market Maker)

    <img src="./images/cpmm.png" style="zoom:60%;" />

    Uniswap에서 사용 중인 방식이다. `x * y = k` 공식을 바탕으로 각 자산의 수량 (유동성) 에 따라 두 자산의 가격대를 형성한다. `k`를 일정하게 유지하기 위해서, `X` 자산의 공급이 늘어나면 `Y` 자산의 공급은 줄어들 수밖에 없고 반대도 마찬가지다.

  - CSMM (Constant Sum Market Maker)

    <img src="./images/csmm.png" style="zoom:60%;" />

    `x + y = k` 공식을 바탕으로 거래가 이뤄진다. 다만 자산의 외부 래퍼런스 가격이 1:1이 아니면 한 쪽의 유동성 풀이 파괴될 수 있는 위험이 있기 때문에 잘 사용되지 않는 모델이다.

  - CMMM (Constant Mean Market Maker)

    `(x * y * z) ^ (1/3) = k` 두 가지 이상의 자산을 토대로 이루어 질 수 있고, 50 : 50 비율 외 다른 가중치 설정이 가능하다.

- Hybrid CFMM (Constant Function Market Maker)

  CPMM 과 CSMM 을 결합하는 등의 복합적인 방식이다.



추가로, AMM에서 살펴봐야 하는 주요 개념 두 가지를 살펴보자.

### 비영구적 손실

IL (Impermanent Loss, 비영구적 손실) 는 유동성 풀에 유동성을 공급한 이후, 예치한 자산의 가격이 변화할 때 발생한다.

예를 들어, A가 유동성 풀에 1 ETH와 100 DAI 를 예치한 경우, 예치된 토큰 Pair의 가치는 동일해야 하므로 이때의 1 ETH는 100 DAI 의 가치인 상태이며, 총 예치한 자산의 가치는 200 DAI 임을 내포한다. 그리고 A와 같은 유동성 공급자가 예치한 총 토큰 량이 10 ETH와 1000 DAI라면, A는 풀의 10% 지분을 보유한다. 더불어 해당 풀은 `10(x) * 1000(y) = 10000` 가격 공식을 따른다.

그리고 시간이 지나서 1 ETH의 가치가 400 DAI 가 된 경우, 유동성의 총 양 (`10000`) 는 유지되지만 풀 내 자산의 비율은 변화한다. 이 경우 `5(x) * 2000(y) = 10000` 공식을 따르게 된다. 그리고 A가 풀에서 자신의 지분 10%만큼을 출금했다면, 0.5 ETH와 200 DAI 를 받게 되어 돌려 받은 총 자산의 가치는 400 DAI 이다. 이렇게 보면 유동성을 제공할 당시에 비해 많은 수익이 발생한 것으로 보여질 수 있다.

그러나 A가 유동성을 공급하지 않고 그저 자산을 보유하고 있었다면, 자산의 수량은 변함없었을 것 이므로 현재 500 DAI 가 되었을 것이다. 여기서 발생한 차이 100 DAI 가 바로 IL 이다. 물론, 이 예시에서는 유동성 풀을 공급한 대가로 받는 Swap 수수료를 고려하지 않았으므로 IL은 조금 더 적을 수 있다.



### 슬리피지

슬리피지 (Slippage) 는 거래를 요청했을 때의 가격과 실제 처리된 가격의 차이를 의미한다.

일반적인 중앙화 거래소에서 $1000로 10 ETH 매수 요청을 보내면 1 ETH 를 $100 매수하는 게 보장된다. 혹여나 Order Book에 해당 가격에 매도 요청 한 ETH 수량이 적어서 한 번에 10 ETH 를 거래하지 못하더라도, 여러 차례로 나누어 $100 가격이 보장된다.

그러나 AMM에서는 유동성 풀에 충분한 유동성이 없다면, 부족한 수량 만큼은 조금 낮은 가격 혹은 높은 가격으로 처리될 수 있다. 여기서 발생하는 차이를 슬리피지라고 한다.



## Uniswap V3

### 이전 버전의 Uniswap 개요

- AMM에서 사용하는 가격 책정 공식에 의해, 즉 Uniswap의 시스템에 의해 가격이 결정되어 유저들은 **오로지 Price Taker** (시장 지배력을 가지고 있지 못해 가격 결정력이 없는 시장 참여자) 로 참여한다.

  그에 반해 Order Book을 기반으로 하는 거래소는 유저들이 Price Maker 혹은 Price Taker 모두 가능하다.

- 대부분의 AMM에서 그렇듯이 **[0, ∞]  가격 범위의 무한한 유동성**을 제공한다.

  그에 반해 Order Book 기반 거래소들은 가격 범위에 제한이 있다.

- 대부분의 AMM에서 그렇듯이 **가격 슬리피지**가 발생할 수 있다.

  그에 반해 Order Book 기반 거래소의 경우 동일 Tick에 거래가 체결될 경우 슬리피지가 발생하지 않는다.



### V3의 핵심 개념, Tick

Uniswap V3에서 제안하는 대부분의 새로운 기능들은 Tick에서 비롯된다.

그에 앞서서 **Tick**이란, 담보의 가격 움직임을 측정하는데 사용되는 가장 작은 단위다. 일반적으로 $ 1.00 이상의 거래에서 Tick 크기는 $ 0.01 이다.

> [Investopedia](https://www.investopedia.com/terms/t/tick-size.asp)
> A tick is a measure of the minimum upward or downward movement in the price of a security. A tick can also refer to the change in the price of a security from one trade to the next trade. Since 2001 and the advent of decimalization, the minimum tick size for stocks trading aboce $ 1.00 is one cent.

거래 가격 범위에 제한이 없는 AMM의 특성을 살려 [0, ∞] 가격 범위를 Tick 단위로 잘게 쪼갬으로써, Uniswap V3에서의 거래는 Order Book 거래소에서 거래하는 것과 유사해진다. 다만 아래의 3가지 다른 점이 있다.

- 각 Tick의 가격 범위는 시스템에 의해 정해지며, 유저들이 제안할 수 없다.
- 하나의 Tick 내에서 일어난 거래는 AMM의 가격 책정 공식을 여전히 따르지만, Tick의 가격 범위를 벗어날 경우 공식 업데이트가 이뤄져야 한다.
- 특정 가격 범위 내에 속하는 어느 가격으로도 주문이 가능하다.

이렇게 Tick을 활용한 시스템 디자인으로, Uniswap V3는 AMM의 이점과 Order Book 기반 거래소의 이점을 살렸다.



### Tick이 가격 범위를 결정하는 방법

위에서 언급했듯, $ 1.00 이상의 일반적인 거래에서 Tick 크기는 $ 0.01 (one cent) 이다. 이는 $ 0.01 가 각 Tick 사이의 가격 변동의 BPS (Basis Points, 1%의 1/100) 라는 의미다. 이 경우 뺄셈을 통해 절대적인 값인 $ 0.01 가 BPS가 된다.

Uniswap V3에서도 비슷한 아이디어를 채택한다. 직전 기준으로 가격은 항상 0.01% 만큼만, 즉 Tick 크기가 0.01% 이어야 한다. 이는 0.01% 가 각 Tick 사이의 가격 변동의 BPS라는 의미다. 이 경우 나눗셈을 통해 퍼센트인 0.01% 가 BPS가 된다. 식으로 표현하면 다음과 같다.
$$
p(i) = 1.0001^i
$$
`p`는 가격을 의미하고, `i`는 Tick의 인덱스 값을 의미한다. 위 공식을 사용하여, Tick 혹은 가격 범위를 인덱스 `[i, i+1]` 범위로부터 계산할 수 있다. 복잡한 숫자 (e.g. `1.0100496621`) 를 저장해놓는 대신, 인덱스 (e.g. `100`) 를 저장해서 공식을 이용해 가격 (e.g. `1.0001¹⁰⁰ = 1.0100496621`) 을 도출한다.

그리고 각 가격은 이전 가격에서 0.01% 만큼만 변해야만 한다. 예를 들어 인덱스 `i = 1`인 경우 `p(1) = 1.0001`이고 `i = 2`인 경우 `p(2) = 1.00020001`이다. 두 인덱스 사이의 가격 변동은 `p(2) / p(1) = 1.0001`이므로 BPS 0.01% 를 만족한다.

만약 가격을 알고 있을 때, Tick 인덱스를 구하기 위해서는 아래의 식을 사용하면 된다.
$$
i = log _{1.0001}(p)
$$
예를 들어, `p = 1000000`인 경우, 위 식의 값으로 `138162.0132` 가 나오므로 해당 가격은 `[138162, 138163]` Tick 인덱스 범위 내에 속한다.



### Concentrated Liquidity  (유동성의 세분화된 제어)

유동성을 집중할 수 있다는 의미는 유동성 공급자 (LPs, Liquidity Providers) 가 그들이 원하는 가격 범위 / Tick에 유동성을 공급할 수 있다는 것이다.

이전 버전에서의 LPs는 모두 `[0, ∞]` 범위에 유동성을 공급했다. 하지만 주로 거래가 이뤄지는 곳은 극히 일부이므로, 대부분의 자산 (유동성) 은 사용되지 않았다는 한계가 있었다.

하지만 각각의 LPs가 원하는 범위에만 유동성을 공급하게 되면, 각 Tick마다 유동성이 불균형해지게 된다. 즉, 각각의 Tick마다 서로 다른 유동성 정도 (Liquidty Depth) 를 갖게 되는 것이고, 따라서 가격 책정 공식인 `x * y = k ` 또한 달라진다. (해당 공식에서의 `x`는 자산 `X`의 Reserve, `y`는 자산 `Y`의 Reserve를 의미)

![](./images/consentrated-liquidty-graph.png)

첫번째 그래프가 이전 버전의 Uniswap 유동성 구조이다. V3부터는 각 유저가 특정 범위에 유동성을 공급하게 되면 두번째 그래프처럼 유동성이 공급되고, 이를 모두 모아서 그래프로 표현하면 마지막 그래프처럼 된다.

예를 들어 `100(x) * 1000(y) = 100000(k)` 상태의 유동성 풀이 있다고 하면, 이때의 자산 `X`의 가격은 자산 `Y`를 기준으로 `1000 / 100 = 10`이다. 그리고 `[9.08, 11.08]` 가격 범위에 해당하는 유동성을 제공했다고 해보자.

만약 `[11.08, 13.08]` 가격 범위에 해당하는 유동성이 `[9.08, 11.08]` 만큼과 동일하다면, 두 범위 경계를 지나갈 때 (자산 `X` 가격이 `11.08`인 경우, `1052.63 / 95 = 11.08`) 가격 공식을 수정할 필요가 없다.

그러나 `[11.08, 13.08]` 가격 범위에 해당하는 유동성이 이전보다 2배만큼 더 있다면, 자산 `X`의 Reserve 수량과 자산 `Y`의 Reserve 수량이 각각 2배이어야 한다. 즉, `(1052.63 * 2) * (110 * 2) = (100000 * 2 * 2)` 식이 성립해야 한다.

여기서 주목할 점은 두가지다.

- 거래는 항상 가격 공식 `x * y = k` 를 따라야 하므로, 가격이 현재의 가격 범위 / Tick를 지나친다면 유동성과 가격 공식은 업데이트되어야 한다.
- `√(x * y) = √k = L` 이 유동성 (`L`, Liquidty) 을 표현하는 식이다. 위의 예시에서 `x * y = 100000` 에서 `x * y = 400000` 으로 늘어났으므로, 유동성은 `√(400000 / 100000) = 2` 배가 된 것이다.

더불어서 이전 버전의 Uniswap에서는 모든 범위 `[0, ∞]`에 유동성을 공급했지만, V3에서는 범위를 세분화할 수 있으므로 같은 양의 유동성을 공급해도 이전 버전 대비 유동성 공급 효율성이 더 높다. [Uniswap Blog](https://uniswap.org/blog/uniswap-v3/#capital-efficiency) 에서 유동성 공급 및 수익 시뮬레이션을 해볼 수 있다.



### Range Orders (범위 한정 주문)

범위 주문은 일반 거래소의 Limit Orders와 유사한 개념이다. 먼저 LPs가 유동성을 제공하는 행위는 범위 주문을 만드는 행위라고 할 수 있다. 그리고 현재 가격과 목표로 하는 가격 범위에 따라서 3가지 경우가 가능하다.

- **현재 가격이 목표 가격 범위에 속하는 경우**

  만약 현재 가격이 정확히 목표 가격 범위 정중앙에 위치한다면, LPs는 동일한 가치의 양쪽 자산만큼 유동성을 제공한다. 그렇지 않은 경우에는 현재 가격이 목표 가격 범위와 얼마나 차이가 나느냐에 따라서 공급되는 유동성이 달라진다. 아래의 케이스에서 함께 살펴보자.

  

- **현재 가격이 목표 가격 범위에 못 미치는 경우**

  첫번째 경우와 달리 현재 가격이 목표 가격 범위 밖에 있다면 한가지 자산만이 필요하다.

  만약 LPs가 가격 범위 `[15.625, 17.313]`에 한해서 유동성을 제공 (Concentrated Liguidity) 했는데, 자산 `X`의 현재 가격이 10 (가격 공식 `100(x) * 1000(y) = 100000`으로부터 도출) 인 경우, 현재 가격이 목표 가격 범위에 못 미치는 경우다.

  자산 `X`의 가격이 `1250 / 80 = 15.625` (가격 공식 `80(x) * 1250(y) = 100000`으로부터 도출) 에 도달하고, 계속해서 가격이 `1315.798 / 76 = 17.313` (가격 공식 `76(x) * 1315.789 = 100000`으로부터 도출) 을 향해 높아진다면, 이는 곧 자산 `X`가 자산 `Y`로 Swap되는 것을 의미한다. 자산 `X` 가격이 올라간다는 것은 `x` (자산 `X`의 Reserve) 가 줄어들고 `y` (자산 `Y` Reserve) 가 늘어나는 것과 같다. 따라서 이 예시의 경우, LPs는 `80 - 76 = 4` 개의 자산 `X`만을 공급하는 꼴이다.

  그리고 자산 `X` 가격이 `17.313`을 넘어서면 LPs가 공급한 4 개의 `X`는 `1315.789 - 1250 = 65.798` 개의 `Y`로 Swap된 상태이다. 그 이후로 다시 `X` 가격이 `[15.626, 17.313]` 내로 돌아온다면 65.789 개의 `Y`가 4 개의 `X`로 다시 Swap될 것이다.

  하지만 `X` 가격이 `17.313`을 넘지 않고 가격 범위 내에 머물고 있다면, LPs는 범위 `[76, 80]` 이내의 `X`와 범위 `[1250, 1315.789]` 이내의 `Y`를 갖고 있으면서 동시에 Swap 수수료를 벌게 된다.

  

- **현재 가격이 목표 가격 범위를 넘어서는 경우**

  위의 두번째 경우와 반대되는 상황이므로, 추가 설명을 생략하겠다.

위 세가지 경우에서 LPs가 Swap 수수료를 벌 수 있는 경우는 오로지 현재 가격이 목표 가격 범위에 속할 때 뿐이므로, 자신들의 수익을 극대화하기 위해 주기적으로 유동성 풀을 모니터링하며 목표 가격 범위를 수정할 것이다. 이는 곧 LPs는 차액을 노리는 중개인 (Arbitrageurs) 이 됨을 의미한다.



### 구조적 변화

- 각각의 자산 Pair에 따라서 다른 종류의 유동성 풀이 존재할 수 있다. 이전 버전에서는 Swap 수수료가 고정되어 있었는데, 이 경우 두 가지 스테이블 코인 Pair 로 구성된 유동성 풀에 있어서는 너무 높은 수치였다. 이런 문제를 해결하기 위해 V3부터는 풀을 생성할 때, Swap 수수료를 0.05%, 0.30%, 1% 중 한가지를 선택할 수 있다. 더불어, 선택지는 UNI 거버넌스에 의해 추가 및 수정이 가능하다.

- Concentrated Liquidty 도입으로 인한 NFT 기반 유동성으로 전환된다. 이전 버전에서는 모든 LPs가 동일한 가격 범위에 유동성을 공급했다. 이는 ERC-20 형식으로, LPs는 유동성을 공급하면 `WBTC/ETH LP` ([Etherscan](https://etherscan.io/token/0xbb2b8038a1640196fbe3e38816f3e67cba72d940)) 과 같은 토큰을 부여 받았다. 하지만 V3부터는 유동성 공급 범위가 제각각이므로 더 이상 ERC-20 형식을 따를 수 없다. 대신 ERC-721 과 같은 NFT 형식이 적합하므로 LPs는 유동성을 공급하면 고유한 NFT 토큰 ([Etherscan](https://etherscan.io/token/0xC36442b4a4522E871399CD717aBDD847Ab11FE88)) 을 받게 된다.

- 이전 버전의 스마트 컨트랙트에서는 현재 `x` (자산 `X`의 Reserve) 와 `y` (자산 `Y`의 Reserve) 를 추적했었다. 그러나 V3부터는 `liquidty(L)` 와 `sqrtPrice(√P)`를 추적한다. 다음 두 식은 `p(i)` 계산 식과 가격 책정 공식에서부터 도출되었다.
  $$
  L=\sqrt (xy)
  $$
  
  $$
  \sqrt P = \sqrt \frac yx
  $$



### Uniswap V3의 Impacts

- 이제껏 Defi 서비스의 성공 혹은 활성화 여부를 TVL (Total Value Locked) 를 기준으로 매기곤 했다. 그러나 V3에서부터는 TVL이 큰 의미를 갖지 않게 된다. 위에서 살펴봤듯이 V3에서의 $1가 V2에서의 $100 혹은 그 이상의 역할을 할 수 있기 때문이다.
- 유동성 공급 전략 설정이 새로운 Defi 서비스로 탄생할 수 있다. 각각의 LPs들은 서로 다른 범위 내에 유동성을 공급한다. 이는 곧 NFT가 되며, 이를 활용하여 어떤 유동성 풀에서는 어떤 NFT를 취하는 전략이 수익을 극대화할 수 있는 컨설팅 혹은 그 이상의 서비스가 만들어질 수 있다.



## 참고 자료 및 사이트

- [Uniswap V3 Core White Paper](https://uniswap.org/whitepaper-v3.pdf)
- [Uniswap V3 Official Blog Post](https://uniswap.org/blog/uniswap-v3/)
- [Chainlink AMM Research Post](https://blog.chain.link/challenges-in-defi-how-to-bring-more-capital-and-less-risk-to-automated-market-maker-dexs-korean/)
- [Medium Post By Taipei Ethereum Meetup](https://medium.com/taipei-ethereum-meetup/uniswap-v3-features-explained-in-depth-178cfe45f223)

